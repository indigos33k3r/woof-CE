#!/bin/bash
#pProcess - process manager
#Copyright 2007,2008,2009,2010,2011,2012,2015
#Sigmund Berglund GPL2

VERSION=3.0
export TEXTDOMAIN=pprocess
export OUTPUT_CHARSET=UTF-8

func() {
	case $1 in
	-action)
		if [ ! "$ACTION" ]; then
			/usr/lib/gtkdialog/box_ok pprocess error "$(gettext 'No action defined')"
			return
		fi
		case $ACTION in
			"$(gettext 'End process (kill)')") kill -9 `echo "$LIST" | awk '{print $1}'`;;
			"$(gettext 'CPU priority') - $(gettext 'High')") renice -10 `echo "$LIST" | awk '{print $1}'`;; #high
			"$(gettext 'CPU priority') - $(gettext 'Normal')") renice 0 `echo "$LIST" | awk '{print $1}'`;; #normal
			"$(gettext 'CPU priority') - $(gettext 'Low')") renice 10 `echo "$LIST" | awk '{print $1}'`;; #low
			*)	#send signal
				KILL_SIGNAL="`echo "$ACTION" | cut -d ' ' -f 3`"
				TMP="-`echo "$KILL_SIGNAL" | cut -d " " -f 1 | tr -d ' '`"
				if [  $TMP = "-0" ]; then TMP=; fi
				kill $TMP `echo "$LIST" | awk '{print $1}'`
		esac
		;;
	-set_filter)
		echo "$FILTER_STRING" > /tmp/pprocess-filter
		;;
	-filter)
		ps --ppid 2 -p 2 --deselect -o pid,user,time,comm > /tmp/pprocess-ps_source
		FILTER_STRING=($(<"/tmp/pprocess-filter"))
		grep -i "$FILTER_STRING" /tmp/pprocess-ps_source > /tmp/pprocess-ps
		;;
	esac
}

export -f func

echo -n > /tmp/pprocess-filter
func -filter

S='
<window title="Pprocess '$VERSION' - '$(gettext 'Process manager')'" icon-name="gtk-execute" default_height="450" default_width="700">
<hbox>
 <tree headers_visible="false" rules_hint="true" hover-selection="true">
  <label>hei</label>
  <variable>LIST</variable>
  <input>cat /tmp/pprocess-ps</input>
  <action signal="button-press-event">func -action</action>
  <action signal="button-press-event">func -filter</action>
  <action signal="button-press-event">refresh:LIST</action>
 </tree>
 <notebook labels="'$(gettext 'ACTION (select first)')'">
  <frame>
   <vbox tooltip-text="'$(gettext 'Use filter to show only wanted processes.
Keep field blank to show all processes.')'">
     <entry activates-default="true" is-focus="true" secondary-icon-stock="gtk-find">
      <variable>FILTER_STRING</variable>
      <width>100</width><height>25</height>
      <action signal="key-release-event">func -set_filter</action>
      <action signal="secondary-icon-release">func -set_filter</action>
      <action condition="command_is_true([[ `echo \"$FILTER_STRING\" | grep -F \"'$(gettext 'Search text')'\"` ]] && echo true)" signal="enter-notify-event">clear:FILTER_STRING</action>
     </entry>
    <hbox>
     <button relief="2" can-default="true" has-default="true" use-stock="true" height-request="1" width-request="1">
      <action>func -filter</action>
      <action>refresh:LIST</action>
     </button>
    </hbox>
    <timer visible="false" interval="4">
     <action>func -filter</action>
     <action>refresh:LIST</action>
    </timer>
   </vbox>
   <tree tooltip-text="'$(gettext 'What should happen to the process
when click on it.')'" headers_visible="false">
    <label>a</label>
    <variable>ACTION</variable>
    <height>100</height><width>270></width>
    <item stock="gtk-cancel">'$(gettext 'End process (kill)')'</item>
    <item stock="gtk-nothing">""</item> 
    <item stock="gtk-go-up">'$(gettext 'CPU priority')' - '$(gettext 'High')'</item> 
    <item stock="gtk-remove">'$(gettext 'CPU priority')' - '$(gettext 'Normal')'</item> 
    <item stock="gtk-go-down">'$(gettext 'CPU priority')' - '$(gettext 'Low')'</item> 
    <item stock="gtk-nothing">""</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 1 - Hangup</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 2 - Interrupt</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 3 - Quit</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 9 - Kill</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 14 - Alarm</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 15 - Terminate</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 18 - Continue</item> 
    <item stock="gtk-nothing">'$(gettext 'Send signal')' 19 - Stop</item>
   </tree>
  </frame>
  </notebook>
</hbox>
</window>'
export PPROCESS="`echo "$S" | sed 's/##.*//'`" #I use double hash (##) for comments. --> as #FF0000
gtkdialog --center -p PPROCESS

